(function() {

    'use strict';

    angular
        .module('app', [
            'app.core',
            'app.filters',
            'app.router',
            'app.components',
            'app.services',
            'app.dashboard',
            'app.material',
            'app.resource',
            'app.plan',
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.components', []);

}());
(function() {

    'use strict';

    angular
        .module('app.core', [
            'ui.router',
            'ngResource'
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.dashboard', [
            'app.core'
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.filters', []);

}());
(function() {

    'use strict';

    angular
        .module('app.material', [
            'app.core'
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.router', [
            'ui.router'
        ]);

}());
(function() {

    'use strict';

    angular
        .module('app.plan', [
            'app.core'
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.resource', [
            'app.core'
        ]);

}());

(function() {

    'use strict';

    angular
        .module('app.services', []);

}());

(function() {

    'use strict';

    angular
        .module('app.components')
        .directive("fileread", fileread);

    fileread.$inject = ['$parse'];
    /* @ngInject */
    function fileread($parse) {
        var directive = {
            restrict: "A",
            scope: {
                fileread: '='
            },
            link: link
        };

        return directive;

        function link(scope, element, attributes) {
            element.bind("change", function (changeEvent) {
                var file = changeEvent.target.files[0];

                var reader = new FileReader();
                reader.onload = function (loadEvent) {

                    var isImage = file.type.substring(0,5) === 'image';

                    scope.fileread = {
                        url: loadEvent.target.result,
                        size: file.size,
                        type: file.type,
                        name: file.name,
                        isImage: isImage
                    };

                    scope.$apply();
                };
                reader.readAsDataURL(file);

            });
        }
    }

}());
(function() {

    'use strict';

    angular
        .module('app.components')
        .directive("filereadMultiple", filereadMultiple);

    filereadMultiple.$inject = ['$parse'];
    /* @ngInject */
    function filereadMultiple($parse) {
        var directive = {
            restrict: "A",
            scope: {
                filereadMultiple: '='
            },
            link: link
        };

        return directive;

        function link(scope, element, attributes) {
            element.bind("change", function (changeEvent) {
                var files = changeEvent.target.files;
                scope.filereadMultiple = [];
                for(var i=0; i<files.length; i++) {
                    (function(file) {
                        var reader = new FileReader();
                        reader.onload = function (loadEvent) {

                            var isImage = file.type.substring(0,5) === 'image';

                            scope.filereadMultiple.push({
                                url: loadEvent.target.result,
                                size: file.size,
                                type: file.type,
                                name: file.name,
                                isImage: isImage
                            });

                            scope.$apply();
                        };
                        reader.readAsDataURL(file);
                    }(files[i]));
                }
            });
        }
    }

}());
(function() {

    'use strict';

    angular
        .module('app.components')
        .directive("flashMessage", flashMessage);

    function flashMessage() {
        var directive = {
            restrict: "E",
            templateUrl: '../../templates/components/flashMessage.html'
        };

        return directive;
    }

}());

(function() {

    'use strict';

    angular.module('app.components').directive("pageLoading", pageLoading);

    function pageLoading() {
        var directive = {
            restrict: "E",
            scope: {},
            template: '<div class="preloader-wrapper active">' + '    <div class="spinner-layer spinner-red-only">' + '      <div class="circle-clipper left">' + '        <div class="circle"></div>' + '      </div><div class="gap-patch">' + '        <div class="circle"></div>' + '      </div><div class="circle-clipper right">' + '        <div class="circle"></div>' + '      </div>' + '    </div>' + '  </div>'
        };

        return directive;
    }

}());

(function() {

    'use strict';

    angular.module('app.components').directive("script", createScript);

    function createScript() {
        var directive = {
            restrict: "E",
            scope: false,
            link: function(scope, elem, attr) {
                if (attr.type === 'text/javascript-lazy') {
                    var s = document.createElement("script");
                    s.type = "text/javascript";
                    var src = elem.attr('src');
                    if (src !== undefined) {
                        s.src = src;
                    } else {
                        var code = elem.text();
                        s.text = code;
                    }
                    document.head.appendChild(s);
                    // elem.remove();
                }
            }
        };

        return directive;
    }

}());

(function() {

    'use strict';

    angular
        .module('app.core')
        .run(appRun);

    appRun.$inject = ['routerHelper'];
    /* @ngInject */
    function appRun(routerHelper) {
        var otherwise = '/dashboard';
        routerHelper.configureStates(getStates(), otherwise);
    }

    function getStates() {
        return [
            {
                state:'root',
                config:{
                    url: '',//'^/xxx'代表绝对路径
                    abstract: true, // abstract: true 表明此状态不能被显性激活，只能被子状态隐性激活
                    views:{
                      'header@root':{
                        templateUrl:'templates/layout/header.html',
                      },
                      'sidebar@root':{
                        templateUrl:'templates/layout/sildebar.html'
                      },
                      '@':{
                        templateUrl:'templates/layout/master.html'
                      }
                    }
                }
            },
            {
                state: '404',
                config: {
                    url: '/404',
                    templateUrl: 'templates/error/404.html',
                    title:'404'
                },
            },
        ];
    }

}());

(function() {

    'use strict';

    angular
        .module("app.dashboard")
        .controller('DashboardController', DashboardController);

    DashboardController.$inject = ['$http'];
    /* @nginject */
    function DashboardController($http) {

        var vm = this;
        vm.ready = true;
        vm.getData = getData;

        getData();

        /**
         * Get Data
         */
        function getData() {
            // $http.get('/admin/api/dashboard').success(function(res) {
            //     vm.users_count      = res.users_count;
            //     vm.posts_count      = res.posts_count;
            //     vm.galleries_count  = res.galleries_count;
            //     vm.ready = true;
            // });
        }
    }

}());

(function() {

    'use strict';

    angular
        .module('app.dashboard')
        .run(appRun);

    appRun.$inject = ['routerHelper'];
    /* @ngInject */
    function appRun(routerHelper) {
        routerHelper.configureStates(getStates());
    }

    function getStates() {
        return [
            {
                state: 'root.dashboard',
                config: {
                        url: '/dashboard',
                        views: {
                            'main': {
                                templateUrl: 'templates/dashboard/dashboard.html',
                                controller: 'DashboardController',
                                controllerAs: 'vm',
                            }
                        },
                        title:'主面板'
                    },
            }
        ];
    }
})();

(function() {

    'use strict';

    angular
        .module('app.filters')
        .filter('roles', roles);

    function roles() {
        return function(role) {
            var roleWords = ['Not Auth', 'Auth', 'Admin', 'Super Admin', 'Owner'];

            return roleWords[role];
        }
    }

}());
(function() {

    'use strict';

    angular
        .module("app.material")
        .controller('MaterialController', MaterialController);

    MaterialController.$inject = ['$http'];
    /* @nginject */
    function MaterialController($http) {
       var vm = this;
        vm.ready = true;
        vm.getData = getData;

        getData();


        /**
         * Get Data
         */
        function getData() {
            // $http.get('/admin/api/dashboard').success(function(res) {
            //     vm.users_count      = res.users_count;
            //     vm.posts_count      = res.posts_count;
            //     vm.galleries_count  = res.galleries_count;
            //     vm.ready = true;
            // });
        }
    }

}());

(function() {

    'use strict';

    angular
        .module('app.material')
        .run(appRun);

    appRun.$inject = ['routerHelper'];
    /* @ngInject */
    function appRun(routerHelper) {
        routerHelper.configureStates(getStates());
    }

    function getStates() {
        return [
            {
                state: 'root.material',
                config: {
                        url: '/material',
                        views: {
                            'main@root': {
                                templateUrl: 'templates/material/materialList.html',
                                controller: 'MaterialController',
                                controllerAs: 'vm',
                            }
                        },
                        title:'素材列表'
                    },
            },
            {
                state: 'root.material.create',
                config: {
                        url: '/material/create',
                        views: {
                            'main@root': {
                                templateUrl: 'templates/material/createMaterial.html',
                                controller: 'MaterialController',
                                controllerAs: 'vm',
                            }
                        },
                        title:'新建素材'
                    },
            }
        ];
    }
})();

/* Help configure the state-base ui.router */
(function() {

    'use strict';

    angular
        .module('app.router')
        .provider('routerHelper', routerHelperProvider);

    routerHelperProvider.$inject = ['$locationProvider', '$stateProvider', '$urlRouterProvider'];
    /* @ngInject */
    function routerHelperProvider($locationProvider, $stateProvider, $urlRouterProvider) {
        /* jshint validthis:true */
        var config = {
            docTitle: 'CMS',
            resolveAlways: {}
        };

        // $locationProvider.html5Mode(true);

        this.configure = function(cfg) {
            angular.extend(config, cfg);
        };

        this.$get = RouterHelper;
        RouterHelper.$inject = ['$location', '$rootScope', '$state'];
        /* @ngInject */
        function RouterHelper($location, $rootScope, $state) {
            var handlingStateChangeError = false;
            var hasOtherwise = false;
            var stateCounts = {
                errors: 0,
                changes: 0
            };

            var service = {
                configureStates: configureStates,
                getStates: getStates,
                stateCounts: stateCounts
            };

            init();

            return service;

            function configureStates(states, otherwisePath) {
                states.forEach(function(state) {
                    state.config.resolve =
                        angular.extend(state.config.resolve || {}, config.resolveAlways);
                    $stateProvider.state(state.state, state.config);
                });
                if (otherwisePath && !hasOtherwise) {
                    hasOtherwise = true;
                    $urlRouterProvider.otherwise(otherwisePath);
                }
            }

            function handleRoutingErrors() {
                // Route cancellation:
                // On routing error, go to the dashboard.
                // Provide an exit clause if it tries to do it twice.
                $rootScope.$on('$stateChangeError',
                    function(event, toState, toParams, fromState, fromParams, error) {
                        if (handlingStateChangeError) {
                            return;
                        }
                        stateCounts.errors++;
                        handlingStateChangeError = true;
                        var destination = (toState &&
                            (toState.title || toState.name || toState.loadedTemplateUrl)) ||
                            'unknown target';
                        var msg = 'Error routing to ' + destination + '. ' +
                            (error.data || '') + '. <br/>' + (error.statusText || '') +
                            ': ' + (error.status || '');
                        console.warn(msg);
                        $location.path('/');
                    }
                );
            }

            function init() {
                handleRoutingErrors();
                updateDocTitle();
            }

            function getStates() { return $state.get(); }

            function updateDocTitle() {
                $rootScope.$on('$stateChangeSuccess',
                    function(event, toState, toParams, fromState, fromParams) {
                        stateCounts.changes++;
                        handlingStateChangeError = false;
                        var title = config.docTitle + ' · ' + (toState.title || '');
                        $rootScope.mainUrl = $state.current.url.split('/')[1];
                        $rootScope.title = title; // data bind to <title>
                    }
                );
            }
        }
    }

})();

(function() {

    'use strict';

    angular
        .module("app.plan")
        .controller('PlanController', PlanController);

    PlanController.$inject = ['$http'];
    /* @nginject */
    function PlanController($http) {

        var vm = this;
        vm.ready = true;
        vm.getData = getData;

        getData();

        /**
         * Get Data
         */
        function getData() {
            // $http.get('/admin/api/dashboard').success(function(res) {
            //     vm.users_count      = res.users_count;
            //     vm.posts_count      = res.posts_count;
            //     vm.galleries_count  = res.galleries_count;
            //     vm.ready = true;
            // });
        }
    }

}());

(function() {

    'use strict';

    angular
        .module('app.plan')
        .run(appRun);

    appRun.$inject = ['routerHelper'];
    /* @ngInject */
    function appRun(routerHelper) {
        routerHelper.configureStates(getStates());
    }

    function getStates() {
        return [
            {
                state: 'root.planList',
                config: {
                        url: '/planList',
                        views: {
                            'main@root': {
                                templateUrl: 'templates/plan/planList.html',
                                controller: 'PlanController',
                                controllerAs: 'vm',
                            }
                        },
                        title:'计划列表'
                    },
            }
        ];
    }
})();

(function() {

    'use strict';

    angular
        .module("app.resource")
        .controller('ResourceController', ResourceController);

    ResourceController.$inject = ['$http'];
    /* @nginject */
    function ResourceController($http) {

        var vm = this;
        vm.ready = true;
        vm.getData = getData;

        getData();

        /**
         * Get Data
         */
        function getData() {
            // $http.get('/admin/api/dashboard').success(function(res) {
            //     vm.users_count      = res.users_count;
            //     vm.posts_count      = res.posts_count;
            //     vm.galleries_count  = res.galleries_count;
            //     vm.ready = true;
            // });
        }
    }

}());

(function() {

    'use strict';

    angular
        .module('app.resource')
        .run(appRun);

    appRun.$inject = ['routerHelper'];
    /* @ngInject */
    function appRun(routerHelper) {
        routerHelper.configureStates(getStates());
    }

    function getStates() {
        return [
            {
                state: 'root.resourceList',
                config: {
                        url: '/resourceList',
                        views: {
                            'main@root': {
                                templateUrl: 'templates/resource/resourceList.html',
                                controller: 'ResourceController',
                                controllerAs: 'vm',
                            }
                        },
                        title:'资源位列表'
                    },
            }
        ];
    }
})();

(function() {

    'use strict';

    angular
        .module("app.services")
        .factory("Post", Post);

    Post.$inject = ['$resource'];
    /* @ngInject */
    function Post($resource) {
        return $resource('/admin/api/posts/:id', {id: '@_id'}, {
            update: {
                method: 'PUT'
            }
        });
    }

}());